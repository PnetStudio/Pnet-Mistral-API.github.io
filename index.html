<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Interface de l'API Mistral</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        #userQuestion {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            box-sizing: border-box;
            font-size: 16px;
            height: 130px;
        }

        #response, #history {
            width: 80%;
            margin: 20px auto;
            padding: 10px;
            font-size: 16px;
            background-color: #fff;
            border: 1px solid #ddd;
            min-height: 50px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .code-block {
            background-color: #f0f0f0;
            border-left: 3px solid #f36d33;
            padding: 1em;
            margin: 1em 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }

        .history-entry {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff; 
        }
        .warning-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 0;
            margin-top: 0;
        }
        h2.history-title {
            font-size: 1.5em;
            color: #333;
        }
        pre {
            background-color: #f4f4f4; 
            border-left: 3px solid #f36d33; 
            padding: 1em;
            overflow-x: auto; 
        }

        .delete-btn, .delete-all-btn {
            background-color: #ff4a4a;
            color: white;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            margin-top: 5px;
        }
        #versionInfo {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            font-size: 14px;
        }

        .delete-btn:hover, .delete-all-btn:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <script>
        var showArchivedHistory = false;

        function requestAPIKey() {
            var apiKey = prompt("Veuillez entrer votre clé API Mistral / Please enter your Mistral API key :");
            if (apiKey) {
                localStorage.setItem("apiKey", apiKey);
                location.reload();
            } else {
                alert("Vous devez fournir une clé API pour utiliser le service Mistral. / You must provide an API key to use the Mistral service.");
            }
        }

        var storedAPIKey = localStorage.getItem("apiKey");

        if (!storedAPIKey) {
            requestAPIKey();
        }

        // Fonction pour traduire le texte
function translateText(text) {
    // Implémentez votre mécanisme de traduction ici
    // Vous pouvez utiliser un objet avec des traductions pour chaque langue
    // Par exemple :
    var translations = {
        "Choisir la langue :": {
            "français": "Choisir la langue :",
            "english": "Choose language:",
            "español": "Elegir idioma:",
            "deutsch": "Sprache wählen:",
            // ... d'autres langues ...
        },
        "Interface Mistral API": {
            "français": "Interface Mistral API",
            "english": "Mistral API Interface",
            "español": "Interfaz de Mistral API",
            "deutsch": "Mistral API Oberfläche",
            // ... d'autres langues ...
        },
        "Choisir un modèle": {
            "français": "Choisir un modèle",
            "english": "Choose a model",
            "español": "Elegir un modelo",
            "deutsch": "Modell auswählen",
            // ... d'autres langues ...
        },
        "Envoyer la question": {
            "français": "Envoyer la question",
            "english": "Send the question",
            "español": "Enviar la pregunta",
            "deutsch": "Frage senden",
            // ... d'autres langues ...
        },
        "Historique des Questions/Réponses": {
            "français": "Historique des Questions/Réponses",
            "english": "History of Questions/Answers",
            "español": "Historial de preguntas/respuestas",
            "deutsch": "Verlauf von Fragen/Antworten",
            // ... d'autres langues ...
        },
        "Supprimer tout l'historique": {
            "français": "Supprimer tout l'historique",
            "english": "Delete all history",
            "español": "Eliminar todo el historial",
            "deutsch": "Den gesamten Verlauf löschen",
            // ... d'autres langues ...
        },
        "Entrez votre question ici": {
            "français": "Entrez votre question ici",
            "english": "Enter your question here",
            "español": "Ingrese su pregunta aquí",
            "deutsch": "Geben Sie hier Ihre Frage ein",
            // ... autres langues ...
        },
        "Nouvelle conversation": {
            "français": "Nouvelle conversation",
            "english": "New conversation",
            "español": "Nueva conversación",
            "deutsch": "Neues Gespräch",
            // ... d'autres langues ...
        },
        "Nouvelle conversation": {
        "français": "Nouvelle conversation",
        "english": "New conversation",
        "español": "Nueva conversación",
        "deutsch": "Neues Gespräch",
        // ... autres langues ...
        },
        "Voir l'historique archivé": {
            "français": "Voir l'historique archivé",
            "english": "View archived history",
            "español": "Ver historial archivado",
            "deutsch": "Archivverlauf anzeigen",
            // ... autres langues ...
        },
        "Supprimer": {
            "français": "Supprimer",
            "english": "Delete",
            "español": "Eliminar",
            "deutsch": "Löschen"
            // ... autres langues ...
        },
        // ... autres textes ...
    };

    var selectedLanguage = getSelectedLanguage();
    return translations[text][selectedLanguage] || text;
}


        function updatePlaceholder() {
            var userQuestionInput = document.getElementById("userQuestion");
            var placeholderText = translateText('Entrez votre question ici');
            userQuestionInput.setAttribute('placeholder', placeholderText);
        }

        document.addEventListener("DOMContentLoaded", function () {
    updatePlaceholder();

    var userQuestionInput = document.getElementById("userQuestion");

    userQuestionInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            callMistralAPI();
        }
    });

    // Ajoutez cet appel pour mettre à jour la langue lors du chargement de la page
    changeLanguage(false);
});
    </script>
    <label for="languageSelect">Choisir la langue :</label>
    <select id="languageSelect" onchange="changeLanguage(false)">
        <option value="français">Français</option>
        <option value="english">English</option>
        <option value="español">Español</option>
        <option value="deutsch">Deutsch</option>
    </select>

    <h1>Interface Mistral API</h1>
    
    <h2>Choisir un modèle</h2>
    <div>
        <label for="modelTiny">mistral-tiny</label>
        <input type="radio" id="modelTiny" name="model" value="mistral-tiny">
    </div>
    <div>
        <label for="modelSmall">mistral-small</label>
        <input type="radio" id="modelSmall" name="model" value="mistral-small" checked>
    </div>
    <div>
        <label for="modelMedium">mistral-medium</label>
        <input type="radio" id="modelMedium" name="model" value="mistral-medium">
    </div><br><br>
    
    <div style="width: 80%; margin: auto;">
        <textarea id="userQuestion" placeholder="Entrez votre question ici"></textarea>
        <button onclick="callMistralAPI()">Envoyer la question</button>
        <button class="new-conversation-btn" onclick="startNewConversation()">Nouvelle conversation</button>
    </div>    

    <div id="apiKeyContainer" style="position: fixed; top: 10px; right: 10px;">
        <button onclick="requestAPIKey()">Changer la clé API</button>
    </div>
    
    
    
    <div id="response"></div>
    <button class="toggle-history-btn" onclick="toggleHistoryView()">Voir l'historique archivé</button>
    <h2 class="history-title">Historique des Questions/Réponses</h2>
    <button class="delete-all-btn" onclick="clearHistory()">Supprimer tout l'historique</button>
    <div id="history"></div>    
    <div id="warning" class="warning-container">
        <p><s>ChatGPT</s> Mistral AI can make mistakes. Consider checking important information.</p>
    </div> 
<script>
function changeLanguage(sendRequest = true) {
    var selectedLanguage = document.getElementById("languageSelect").value;
    localStorage.setItem("selectedLanguage", selectedLanguage);

    // Appelle la fonction callMistralAPI seulement si sendRequest est true
    if (sendRequest) {
        callMistralAPI();
    }

    // Mettez à jour l'interface en fonction de la langue
    updateInterfaceLanguage();

    // Mettez à jour les textes de l'interface
    updateInterfaceTexts();

    updatePlaceholder();
}

function updateInterfaceTexts() {
    // Obtenez la langue sélectionnée
    var selectedLanguage = getSelectedLanguage();

    // Mettez à jour les textes de l'interface ici en fonction de la langue sélectionnée
    document.querySelector("label[for='languageSelect']").textContent = translateText("Choisir la langue :");
    document.querySelector("h1").textContent = translateText("Interface Mistral API");
    document.querySelector("h2").textContent = translateText("Choisir un modèle");
    document.querySelector("button").textContent = translateText("Envoyer la question");
    document.querySelector("h2.history-title").textContent = translateText("Historique des Questions/Réponses");
    document.querySelector("button.delete-all-btn").textContent = translateText("Supprimer tout l'historique");
    document.querySelector("button.new-conversation-btn").textContent = translateText("Nouvelle conversation");
    document.querySelector("button.delete-all-btn").textContent = translateText("Supprimer");
    document.querySelector("button.toggle-history-btn").textContent = translateText("Voir l'historique archivé");
}


        function updateInterfaceLanguage() {
            // Mettez à jour ici les éléments d'interface en fonction de la langue sélectionnée
            // Par exemple, vous pouvez changer le texte, les étiquettes, etc.

            // Exemple : Changez le texte de l'étiquette h1
            document.querySelector("h1").textContent = "Interface Mistral API";

            // Ajoutez d'autres mises à jour d'interface en fonction de vos besoins
        }

        // Fonction pour obtenir la langue actuellement sélectionnée
        function getSelectedLanguage() {
            return localStorage.getItem("selectedLanguage") || "fr"; // Par défaut, la langue est le français
        }

        // Utilisez la fonction pour obtenir la langue actuellement sélectionnée
        var selectedLanguage = getSelectedLanguage();

        // Affiche la langue sélectionnée dans la console (vous pouvez le modifier selon vos besoins)
        console.log("Langue sélectionnée :", selectedLanguage);

        let history = JSON.parse(localStorage.getItem("history")) || [];
        renderHistory();

        var apiCallInProgress = false; 

        function callMistralAPI() {
    console.log("Calling Mistral API...");

    if (apiCallInProgress) {
        return;
    }
    apiCallInProgress = true;

    // Utilisez la première déclaration de apiKey
    var apiKey = localStorage.getItem("apiKey");

    // Vérifie si une clé API Mistral a été fournie
    if (!apiKey) {
        alert("Veuillez entrer votre clé API Mistral.");
        apiCallInProgress = false; // Réinitialisez la variable ici
        return;
    }

    // Récupère la question actuelle de l'utilisateur
    var question = document.getElementById("userQuestion").value;
    var selectedModel = document.querySelector('input[name="model"]:checked').value;

    // Récupère la langue sélectionnée
    var selectedLanguage = getSelectedLanguage();

    // Crée un tableau des messages de l'utilisateur
    var userMessages = [
        {
            "role": "user",
            "content_type": "prompt",
            "content": question
        },
        {
            "role": "user",
            "content_type": "language",
            "content": selectedLanguage
        }
    ];

    // Ajoute les questions précédentes de l'historique
    userMessages = userMessages.concat(
        history.map(entry => ({
            "role": "user",
            "content_type": "prompt",
            "content": entry.question
        }))
    );

    // Prépare la requête vers l'API Mistral
    var xhr = new XMLHttpRequest();
    var url = "https://api.mistral.ai/v1/chat/completions";
    var data = JSON.stringify({
        "model": selectedModel,
        "messages": userMessages
    });

    // Gère la réponse de l'API
    xhr.onreadystatechange = function () {
    console.log("XHR Ready State:", xhr.readyState, "Status:", xhr.status);

    if (xhr.readyState == 4) {
        if (xhr.status == 200) {
            console.log("API Response:", xhr.responseText);
            var result = JSON.parse(xhr.responseText);
            var content = result['choices'][0]['message']['content'];

            // Met à jour la réponse dans l'interface
            updateResponse(content);

            // Ajoute à l'historique
            addToHistory(question, content, selectedModel);
        } else {
            console.error("Error during request. Status code:", xhr.status);
            document.getElementById("response").innerHTML = "<p>Error during request. Status code: " + xhr.status + '</p>';
        }

        // Réinitialisez la variable ici
        apiCallInProgress = false;
        }
    };


    // Configure et envoie la requête vers l'API Mistral
    xhr.open("POST", url, true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.setRequestHeader("Accept", "application/json");
    xhr.setRequestHeader("Authorization", "Bearer " + apiKey);
    xhr.send(data);
}


function addToHistory(question, answer, model) {
    history.push({
        question,
        answer,
        model
    });

    // Limite de l'historique à 50 entrées
    const maxHistoryLength = 50;
    if (history.length > maxHistoryLength) {
        history.splice(0, history.length - maxHistoryLength);
    }

    // Sauvegarde et met à jour l'affichage de l'historique
    saveHistory();
    renderHistory();
}

function updateResponse(content) {
    // Efface le contenu précédent
    document.getElementById("response").innerHTML = '';

    // Sépare les blocs de code du reste du texte
    const sections = content.split(/(```.*?```)/gs);

    sections.forEach(section => {
        if (section.startsWith("```") && section.endsWith("```")) {
            // Crée et affiche le bloc de code
            const codeContent = section.substring(3, section.length - 3);
            const codeBlock = document.createElement('div');
            codeBlock.className = 'code-block';
            codeBlock.textContent = codeContent;
            document.getElementById("response").appendChild(codeBlock);
        } else {
            // Affiche le texte normal
            const textBlock = document.createElement('div');
            textBlock.textContent = section;
            document.getElementById("response").appendChild(textBlock);
            }
        });
        }
        function startNewConversation() {
            // Archiver l'historique actuel sans affecter l'affichage actuel
            archiveHistory();
            // Rafraîchir seulement l'affichage de l'historique
            renderHistory();
        }
        function toggleHistoryView() {
            showArchivedHistory = !showArchivedHistory;
            renderHistory(); // Make sure to call the renderHistory function after toggling
        }
        function archiveHistory() {
            // Récupérer l'historique actuel depuis le stockage local
           const archivedHistory = JSON.parse(localStorage.getItem("archivedHistory")) || [];

            // Ajouter l'historique actuel à l'archive
            archivedHistory.push(...history);

            // Sauvegarder l'archive dans le stockage local
            localStorage.setItem("archivedHistory", JSON.stringify(archivedHistory));

             // Effacer l'historique actuel
            history = [];
            saveHistory();
            }



            function renderHistory() {
                const historyDiv = document.getElementById("history");
                historyDiv.innerHTML = '';

                const displayedHistory = showArchivedHistory ? getArchivedHistory() : history;

                const reversedHistory = displayedHistory.slice().reverse();

                reversedHistory.forEach((entry, index) => {
                // Créez un nouveau div pour l'entrée d'historique
                const entryDiv = document.createElement("div");
                entryDiv.className = "history-entry";

                // Utilisez des éléments de texte préformaté pour le code
                const formattedAnswer = entry.answer.replace(/(```.*?```)/gs, function(match) {
                    return `<pre>${match.slice(3, -3)}</pre>`; // Retirez les backticks et utilisez la balise <pre>
                });

                // Construisez le contenu HTML avec la question, la réponse formatée et le modèle
                entryDiv.innerHTML = `
                    <p><strong>Question :</strong> ${entry.question}</p>
                    <p><strong>Réponse :</strong></p>
                    ${formattedAnswer}
                    <p><strong>Modèle :</strong> ${entry.model}</p>
                    <button class="delete-btn" onclick="deleteEntry(${index})">${translateText("Supprimer")}</button>`;


                // Ajoutez le div formaté à l'historique
                historyDiv.appendChild(entryDiv);
            });
        }
        function getArchivedHistory() {
            return JSON.parse(localStorage.getItem("archivedHistory")) || [];
        }
       

        function deleteEntry(index) {
        if (showArchivedHistory) {
            // Si l'affichage est basculé vers l'historique archivé, supprimez de l'archivage
            const archivedHistory = getArchivedHistory();
            archivedHistory.splice(index, 1);
            localStorage.setItem("archivedHistory", JSON.stringify(archivedHistory));
        } else {
            // Sinon, supprimez de l'historique actuel
            history.splice(index, 1);
            saveHistory();
        }

        renderHistory();
    }

    function clearHistory() {
        if (showArchivedHistory) {
            // Si l'affichage est basculé vers l'historique archivé, effacez l'archivage
            localStorage.removeItem("archivedHistory");
        } else {
            // Sinon, effacez l'historique actuel
            history = [];
            saveHistory();
        }

        renderHistory();
    }

        function saveHistory() {
            localStorage.setItem("history", JSON.stringify(history));
        }
    </script>
    <br><br><br><br><br><br>
    <footer>
        <section id="legal-notice">
            <h2>Legal Notice</h2>
    
            <p>This website is the property of © 2024 PNETStudio.</p>
    
            <p>PNETStudio<br>
            Email: pnet.group@outlook.com</p>
            <p>Design and Development: ©PNETStudio</p>
            
            <h3>Personal Data Protection</h3>

            <p>What are these?</p>
    
            <h3>Terms of Use</h3>
    
            <p>By using this site, you agree to the current terms of use. © 2024 PNETStudio reserves the right to modify these terms at any time, without prior notice.</p>
    
            <h3>Contact</h3>
    
            <p>You can contact us at the following address: pnet.group@outlook.com</p>
            
        </section>
    </footer>
    <div id="versionInfo">v 0.0.94</div>
</body>
</html>
